!function(){function a(){}function b(b){a.log("instantiating quorra plot object"),"undefined"==typeof b&&(b={});var d=this;return this.go=function(b){a.log("running generator function"),"undefined"==typeof b&&(b=d.attr.bind),d.selection="string"==typeof b?d3.select(b):b,null!==d.selection.select("svg")[0][0]&&d.selection.select("svg").selectAll("*").remove(),d.attr.svg=null===d.attr.svg?d.selection.append("svg"):d.attr.svg;var c="auto"===d.attr.width?parseInt(d.selection.style("width")):d.attr.width,e="auto"===d.attr.height?parseInt(d.selection.style("height")):d.attr.height;d.innerwidth=c-d.attr.margin.left-d.attr.margin.right,d.innerheight=e-d.attr.margin.top-d.attr.margin.bottom,d3.selectAll("div.quorra-tooltip#"+d.attr.id+"-tooltip").remove(),d.attr.tooltip===!0&&(d.attr.tooltip=d3.select("body").append("div").attr("class","quorra-tooltip").attr("id",d.attr.id+"-tooltip").style("position","fixed").style("visibility","hidden").style("z-index",999)),d.attr.svg=d.attr.svg.attr("id",d.attr.id).attr("class",d.attr["class"]).attr("width",c).attr("height",e),d.defs=d.attr.svg.append("defs"),d.defs.append("clipPath").attr("id","clip-"+d.attr.id).append("rect").attr("x",0).attr("y",0).attr("width",d.innerwidth).attr("height",d.innerheight),d.plotregion=d.attr.svg.append("g").attr("class","plotregion").attr("transform","translate("+d.attr.margin.left+","+d.attr.margin.top+")"),d.data=d.attr.transform(d.attr.data),"string"==typeof d.data[0].x?d.attr.xorder.length>0?d.domain=d.attr.xorder:d.domain=_.uniquesort(d.data,d.attr.x):d.domain=[_.min(_.map(d.data,d.attr.x)),_.max(_.map(d.data,d.attr.x))];var f;if("string"==typeof d.data[0].y)d.attr.yorder.length>0?d.range=d.attr.yorder:d.range=_.uniquesort(d.data,d.attr.y);else{if("stacked"===d.attr.layout){var g=_.uniquesort(d.data,d.attr.x);f=_.max(_.map(g,function(a){var b=_.filter(d.data,function(b){return d.attr.x(b)==a}),c=_.map(b,function(a){return d.attr.y(a)});return _.reduce(c,function(a,b){return a+b},0)}))}else f=_.max(_.map(d.data,d.attr.y));d.range=[_.min(_.map(d.data,d.attr.y)),f]}return d.pallette="auto"===d.attr.color?d3.scale.category10():d3.scale.ordinal().range(d.attr.color),d.pallette=d.pallette.domain(_.uniquesort(d.data,d.attr.group)),d.enabled={zoom:!1,pan:!1,annotate:!1},d.xstack=[],d.ystack=[],d.attr.legend&&d.drawlegend(),d.attr.zoomable&&d.enablezoom(),d.attr.annotatable&&d.enableannotation(),d.attr.glyphs&&d.drawglyphs(),d.redraw(),d.attr.slider&&d.slider(),d},this.redraw=function(b,c,e){a.log("redrawing plot"),"undefined"!=typeof b&&(d.attr.xrange=b),"undefined"!=typeof c&&(d.attr.yrange=c),"undefined"==typeof e&&(e=!0),d.plotregion.selectAll("*").remove(),d.axes(),d.plotarea=d.plotregion.append("g").attr("class","plotarea").attr("clip-path","url(#clip-"+d.attr.id+")"),d.plot(),e&&(d.xstack.push(d.xscale),d.ystack.push(d.yscale)),d.attr.annotation&&d.annotate()},this.axes=function(){a.log("redrawing axes");var b="auto"===d.attr.xrange?d.domain:d.attr.xrange,c="auto"===d.attr.yrange?d.range:d.attr.yrange;"histogram"===d.type&&(b[1]=b[1]+(b[1]-b[0])/(d.attr.bins-1)),d.xmapper=function(a){return a},"string"==typeof d.data[0].x&&(d.xord=d3.scale.ordinal().domain(d.domain).range(_.range(d.domain.length)),d.xordrev=d3.scale.ordinal().domain(d.xord.range()).range(d.xord.domain()),d.xmapper=function(a){return d.xord(a)},"string"==typeof b[0]&&(b=_.map(b,d.xmapper),b[0]=b[0]-.5,b[b.length-1]=b[b.length-1]+.5)),d.xscale=d3.scale.linear().domain([b[0],b[b.length-1]]).range([0,d.innerwidth]),d.xaxis=d3.svg.axis().scale(d.xscale).orient(d.attr.xorient),"auto"!==d.attr.xticks?d.xaxis=d.xaxis.ticks(d.attr.xticks):"histogram"===d.type&&(d.xaxis=d.xaxis.ticks(d.attr.bins)),d.xaxis=d.xaxis.tickFormat(d.attr.xformat),"string"==typeof d.data[0].x&&("string"==typeof b[0]&&(b=_.map(b,d.xord)),d.xaxis=d.xaxis.tickValues(_.range(Math.ceil(b[0]),Math.floor(b[b.length-1])+1)).tickFormat(function(a){return d.attr.xformat(d.xordrev(a))})),d.ymapper=function(a){return a},"string"==typeof d.data[0].y&&(d.yord=d3.scale.ordinal().domain(d.range).range(_.range(d.range.length)),d.yordrev=d3.scale.ordinal().domain(d.yord.range()).range(d.yord.domain()),d.ymapper=function(a){return d.yord(a)},"string"==typeof c[0]&&(c=_.map(c,d.ymapper),c[0]=c[0]-.5,c[c.length-1]=c[c.length-1]+.5)),d.yscale=d3.scale.linear().domain([c[0],c[c.length-1]]).range([d.innerheight,0]),d.yaxis=d3.svg.axis().scale(d.yscale).orient(d.attr.yorient),"auto"!==d.attr.yticks&&(d.yaxis=d.yaxis.ticks(d.attr.yticks)),d.yaxis=d.yaxis.tickFormat(d.attr.yformat),"string"==typeof d.data[0].y&&("string"==typeof c[0]&&(c=_.map(c,d.yord)),d.yaxis=d.yaxis.tickValues(_.range(Math.ceil(c[0]),Math.floor(c[c.length-1])+1)).tickFormat(function(a){return d.attr.yformat(d.yordrev(a))})),d.attr.grid&&(d.xaxis=d.xaxis.tickSize(-d.innerheight,0,0),d.yaxis=d.yaxis.tickSize(-d.innerwidth,0,0)),"hidden"!==d.attr.xaxis&&d.attr.xaxis!==!1&&d.plotregion.append("g").attr("class","x axis").attr("transform","translate(0,"+d.innerheight+")").call(d.xaxis).append("text").attr("class","label").attr("x",function(a){return"end"===d.attr.labelposition?d.innerwidth:"middle"===d.attr.labelposition?d.innerwidth/2:"beginning"===d.attr.labelposition?0:void 0}).attr("y",function(){return"inside"===d.attr.xaxis?-6+d.attr.labelpadding.x:"outside"===d.attr.xaxis?35+d.attr.labelpadding.x:void 0}).style("text-anchor",d.attr.labelposition).text(d.attr.xlabel),"hidden"!==d.attr.yaxis&&d.attr.yaxis!==!1&&d.plotregion.append("g").attr("class","y axis").call(d.yaxis).append("text").attr("class","label").attr("transform","rotate(-90)").attr("x",function(a){return"end"===d.attr.labelposition?0:"middle"===d.attr.labelposition?-d.innerheight/2:"beginning"===d.attr.labelposition?-d.innerheight:void 0}).attr("y",function(){return"inside"===d.attr.yaxis?6+d.attr.labelpadding.y:"outside"===d.attr.yaxis?-40+d.attr.labelpadding.y:void 0}).attr("dy",".71em").style("text-anchor",d.attr.labelposition).text(d.attr.ylabel)},this.plot=function(){a.log("To be implemented by models ...")},this.annotate=function(){a.log("drawing plot annotation"),_.map(d.attr.annotation,function(b){a.render(b)})},this.slider=function(){if(a.log("instantiating plot slider"),null!=d.attr.slider){var b=function(a,b){var c=a.attr.slider.__parent__,d=c.attr.annotation.length-1,e=c.attr.annotation[d].x(),f=e+c.attr.annotation[d].width(),g=c.attr.annotation[d].y(),h=g-c.attr.annotation[d].height();a.redraw([e,f],[h,g],b)},c=function(a){var b=a.attr.slider.__parent__,c=a.xscale.domain(),d=a.yscale.domain(),e=b.attr.annotation.length-1,f=b.attr.annotation[e],g=c[c.length-1]-c[0],h=d[d.length-1]-d[0];f.x(c[0]),f.y(d[d.length-1]),f.width(g),f.height(h),a.attr.slider.__parent__.redraw()},e="auto"===d.attr.xrange?d.domain:d.attr.xrange,f="auto"===d.attr.yrange?d.range:d.attr.yrange;"string"==typeof e[0]&&(e=_.map(e,d.xmapper));var g=Math.abs(e[e.length-1]-e[0]),h=Math.abs(f[f.length-1]-f[0]),i=d.attr.slider.annotation().concat([{type:"rect",width:g,height:h,draggable:!0,x:e[0],y:f[1],style:{opacity:.25},hoveropacity:.2,events:{drag:function(){a.log("dragging slider"),b(d,!1)},dragend:function(){a.log("dragging slider"),b(d,!0)}}}]);d.attr.slider.annotation(i),d.attr.events.panold=d.attr.events.pan,d.attr.events.pan=function(){c(d),d.attr.events.panold()},d.attr.events.zoomold=d.attr.events.zoom,d.attr.events.zoom=function(){c(d),d.attr.events.zoomold()},a.render(d.attr.slider)}},this.hotdata=function(){var a=d.xscale.domain(),b=d.yscale.domain();return _.filter(d.data,function(c,e){var f=d.xmapper(d.attr.x(c,e)),g=d.ymapper(d.attr.y(c,e));return f>=a[0]&&f<=a[1]&&g>=b[0]&&g<=b[1]?!0:!1})},this.drawlegend=function(){a.log("drawing plot legend");var b=d.pallette.domain();d.attr.lorder.length===b.length&&(b=d.attr.lorder);var c="auto"===d.attr.width?parseInt(d.selection.style("width")):d.attr.width;"auto"===d.attr.height?parseInt(d.selection.style("height")):d.attr.height;c="inside"===d.attr.lposition?c-22:c;var e,f=d.attr.svg.append("g").attr("transform","translate("+(c-d.attr.margin.right)+","+d.attr.margin.top+")").selectAll(".legend").data(b).enter().append("g").attr("class","legend").attr("id",d.attr.id+"-legend").attr("transform",function(a,b){return"translate(0,"+(d.attr.lmargin.top+20*b)+")"});"square"===d.attr.lshape?e=f.append("rect").attr("class","selector").attr("x",5+d.attr.lmargin.left).attr("y",d.attr.lmargin.top).attr("width",18).attr("height",18).attr("rx",5).attr("ry",5).style("fill",d.pallette).style("fill-opacity",function(a){return _.contains(d.attr.toggled,a)?0:d.attr.opacity}):"circle"===d.attr.lshape&&(e=f.append("circle").attr("class","selector").attr("cx",20+d.attr.lmargin.left).attr("cy",8+d.attr.lmargin.top).attr("r",9).style("fill",d.pallette).style("fill-opacity",function(a){return _.contains(d.attr.toggled,a)?0:d.attr.opacity})),d.attr.toggle&&e.on("mouseover",function(a,b){d3.select(this).style("opacity",.75)}).on("mouseout",function(a,b){d3.select(this).style("opacity",1)}).on("click",function(a,b){0===parseFloat(d3.select(this).style("fill-opacity"))?(d3.select(this).style("fill-opacity",_.contains(d.attr.toggled,a)?d.attr.opacity:0),d.attr.svg.selectAll(".g_"+a).style("visibility","visible"),d.attr.toggled=_.without(d.attr.toggled,a)):(d3.select(this).style("fill-opacity",0),d.attr.svg.selectAll(".g_"+a).style("visibility","hidden"),d.attr.toggled=_.union(d.attr.toggled,[a]))}),f.append("text").attr("x",function(){if("inside"===d.attr.lposition)return d.attr.lmargin.left;if("outside"===d.attr.lposition){var a="square"===d.attr.lshape?0:7;return 27+d.attr.lmargin.left+a}}).attr("y",9+d.attr.lmargin.top).attr("dy",".35em").style("text-anchor",function(){return"inside"===d.attr.lposition?"end":"outside"===d.attr.lposition?"beginning":void 0}).text(function(a){return a})},this.drawglyphs=function(){a.log("drawing plot glyphs"),d.defs.append("symbol").attr("id","glyph-refresh").attr("viewBox","0 0 1024 1024").append("path").attr("d","M1024 384h-384l143.53-143.53c-72.53-72.526-168.96-112.47-271.53-112.47s-199 39.944-271.53 112.47c-72.526 72.53-112.47 168.96-112.47 271.53s39.944 199 112.47 271.53c72.53 72.526 168.96 112.47 271.53 112.47s199-39.944 271.528-112.472c6.056-6.054 11.86-12.292 17.456-18.668l96.32 84.282c-93.846 107.166-231.664 174.858-385.304 174.858-282.77 0-512-229.23-512-512s229.23-512 512-512c141.386 0 269.368 57.326 362.016 149.984l149.984-149.984v384z"),d.defs.append("symbol").attr("id","glyph-search").attr("viewBox","0 0 1024 1024").append("path").attr("d","M992.262 871.396l-242.552-206.294c-25.074-22.566-51.89-32.926-73.552-31.926 57.256-67.068 91.842-154.078 91.842-249.176 0-212.078-171.922-384-384-384-212.076 0-384 171.922-384 384s171.922 384 384 384c95.098 0 182.108-34.586 249.176-91.844-1 21.662 9.36 48.478 31.926 73.552l206.294 242.552c35.322 39.246 93.022 42.554 128.22 7.356s31.892-92.898-7.354-128.22zM384 640c-141.384 0-256-114.616-256-256s114.616-256 256-256 256 114.616 256 256-114.614 256-256 256z"),d.defs.append("symbol").attr("id","glyph-image").attr("viewBox","0 0 1024 1024").html(['<path d="M959.884 128c0.040 0.034 0.082 0.076 0.116 0.116v767.77c-0.034 0.040-0.076 0.082-0.116 0.116h-895.77c-0.040-0.034-0.082-0.076-0.114-0.116v-767.772c0.034-0.040 0.076-0.082 0.114-0.114h895.77zM960 64h-896c-35.2 0-64 28.8-64 64v768c0 35.2 28.8 64 64 64h896c35.2 0 64-28.8 64-64v-768c0-35.2-28.8-64-64-64v0z"></path>','<path d="M832 288c0 53.020-42.98 96-96 96s-96-42.98-96-96 42.98-96 96-96 96 42.98 96 96z"></path>','<path d="M896 832h-768v-128l224-384 256 320h64l224-192z"></path>'].join("")),d.defs.append("symbol").attr("id","glyph-pan").attr("viewBox","0 0 1024 1024").html(['<path d="M1024 0h-416l160 160-192 192 96 96 192-192 160 160z"></path>','<path d="M1024 1024v-416l-160 160-192-192-96 96 192 192-160 160z"></path>','<path d="M0 1024h416l-160-160 192-192-96-96-192 192-160-160z"></path>','<path d="M0 0v416l160-160 192 192 96-96-192-192 160-160z"></path>'].join("")),d.defs.append("symbol").attr("id","glyph-annotate").attr("viewBox","0 0 1024 1024").append("path").attr("d","M864 0c88.364 0 160 71.634 160 160 0 36.020-11.91 69.258-32 96l-64 64-224-224 64-64c26.742-20.090 59.978-32 96-32zM64 736l-64 288 288-64 592-592-224-224-592 592zM715.578 363.578l-448 448-55.156-55.156 448-448 55.156 55.156z");var b=[];d.attr.annotatable&&b.push("annotate"),d.attr.zoomable&&b.push("pan","refresh"),d.attr.exportable&&b.push("export");var c=d.attr.svg.append("g").attr("transform","translate("+(d.innerwidth+d.attr.margin.left+5)+","+(d.innerheight-d.attr.margin.bottom-22*b.length+52)+")").selectAll(".glyphbox").data(b).enter().append("g").attr("class","glyphbox").attr("id",function(a){return a}).attr("transform",function(a,b){return"translate(0,"+25*b+")"}).on("mouseover",function(a){d3.select(this).style("opacity",.5),d.attr.tooltip&&d.attr.tooltip.html(a).style("visibility","visible").style("left",d3.event.clientX+10+"px").style("top",d3.event.clientY-10+"px")}).on("mousemove",function(a){d.attr.tooltip&&d.attr.tooltip.style("left",d3.event.clientX+10+"px").style("top",d3.event.clientY-10+"px")}).on("mouseout",function(a){d3.select(this).style("opacity",1),d.attr.tooltip&&d.attr.tooltip.style("visibility","hidden")}).on("click",function(b){switch(b){case"zoom":d.enabled.zoom=!d.enabled.zoom,this.enabled.pan=!d.enabled.pan,d3.select(this).selectAll(".glyph").style("stroke-width",d.enabled.zoom?2:1).style("stroke",d.enabled.zoom?"black":"#ddd");break;case"pan":d.enabled.pan=!d.enabled.pan,d.enabled.zoom=!d.enabled.zoom,d3.select(this).selectAll(".glyph").style("stroke-width",d.enabled.pan?2:1).style("stroke",d.enabled.pan?"black":"#ddd");break;case"refresh":d.xstack=[d.xstack[0]],d.ystack=[d.ystack[0]],d.redraw(d.xstack[0].domain(),d.ystack[0].domain(),!1),d.attr.events.zoom();break;case"annotate":d.enabled.annotate=!d.enabled.annotate,d3.select(this).selectAll(".glyph").style("stroke-width",d.enabled.annotate?2:1).style("stroke",d.enabled.annotate?"black":"#ddd");break;case"export":d.attr.events.preexport(d.attr),a["export"](d.attr.svg,d.attr.plotname),d.attr.events.postexport(d.attr)}});"square"===d.attr.gshape?c.append("rect").attr("class","glyph").attr("width",22).attr("height",22).attr("rx",5).attr("ry",5).style("fill","transparent"):c.append("circle").attr("class","glyph").attr("cx",11).attr("cy",7).attr("r",11).style("fill","transparent"),c.append("svg").attr("width",22).attr("height",22).append("use").attr("x",("square"===d.attr.gshape,4)).attr("y","square"===d.attr.gshape?4:0).attr("height",14).attr("width",14).attr("xlink:href",function(a){switch(a){case"zoom":return"#glyph-search";case"pan":return"#glyph-pan";case"refresh":return"#glyph-refresh";case"export":return"#glyph-image";case"annotate":return"#glyph-annotate"}})},this.enablezoom=function(){function b(a){return a.x>d.innerwidth||a.x<0||a.y>d.innerheight||a.y<0?!1:!0}a.log("enabling zoom events"),d.zoomdata={x:d.attr.margin.left,y:d.attr.margin.right},d.enabled.pan=!1,d.enabled.zoom=!0;var e=d.attr.svg.append("path").attr("class","viewbox").attr("transform","translate("+d.attr.margin.left+","+d.attr.margin.top+")"),f=d3.behavior.drag().on("dragstart",function(a){var b=c(d.attr.svg);d.zoomdata.x=b.x-d.attr.margin.left,d.zoomdata.y=b.y-d.attr.margin.top,d.enabled.pan&&d.attr.events.panstart(d.attr)}).on("dragend",function(a){e.attr("d","");var b=c(d.attr.svg);if(b.x=b.x-d.attr.margin.left,b.y=b.y-d.attr.margin.top,d.enabled.zoom){var f,g,h=!1,i=d.xstack.length;if(Math.abs(d.zoomdata.x-b.x)>10&&d.zoomdata.x>0){var j=d.xstack[i-1].domain(),k=d.xstack[i-1].range(),l=d3.scale.linear().domain(k).range(j);f=[l(d.zoomdata.x),l(b.x)].sort(function(a,b){return a-b}),f[0]=Math.max(f[0],j[0]),f[1]=Math.min(f[1],j[1]);d3.scale.linear().domain(f).range(k);h=!0}if(Math.abs(d.zoomdata.y-b.y)>10&&d.zoomdata.y<d.innerheight){var m=d.ystack[i-1].domain(),n=d.ystack[i-1].range(),o=d3.scale.linear().domain(n).range(m);g=[o(d.zoomdata.y),o(b.y)].sort(function(a,b){return a-b}),g[0]=Math.max(g[0],m[0]),g[1]=Math.min(g[1],m[1]);d3.scale.linear().domain(g).range(n);h=!0}h&&(d.redraw(f,g,!0),d.attr.events.zoom(d.attr))}else d.enabled.pan&&(d.xstack.push(d.xscale),d.ystack.push(d.yscale),d.attr.events.panend(d.attr))}).on("drag",function(a){var f=c(d.attr.svg);if(f.x=f.x-d.attr.margin.left,f.y=f.y-d.attr.margin.top,d.enabled.zoom)d.zoomdata.y>d.innerheight&&(f.y=0),d.zoomdata.x<0&&(f.x=d.innerwidth),e.attr("d",["M"+d.zoomdata.x+","+d.zoomdata.y,"L"+d.zoomdata.x+","+f.y,"L"+f.x+","+f.y,"L"+f.x+","+d.zoomdata.y,"Z"].join(""));else if(d.enabled.pan&&b(f)){e.attr("d","");var g=d3.scale.linear().domain(d.xscale.range()).range(d.xscale.domain()),h=d3.scale.linear().domain(d.yscale.range()).range(d.yscale.domain()),i=_.map(d.xscale.range(),function(a){return g(a-d3.event.dx)}),j=_.map(d.yscale.range(),function(a){return h(a-d3.event.dy)});d.redraw(i,j,!1);var k=d.xstack.length;d.xscale=d3.scale.linear().domain(i).range(d.xstack[k-1].range()),d.yscale=d3.scale.linear().domain(j).range(d.ystack[k-1].range()),d.attr.events.pan(d.attr)}});d.attr.svg.on("dblclick",function(){var a=d.xstack.length;a>1&&(d.xstack.pop(),d.ystack.pop(),a-=1),d.redraw(d.xstack[a-1].domain(),d.ystack[a-1].domain(),!1),d.attr.events.zoom()}).call(f).on("dblclick.zoom",null).on("mousedown.zoom",null).on("touchstart.zoom",null).on("touchmove.zoom",null).on("touchend.zoom",null),a.events.Shift.down=function(){d3.selectAll(".glyphbox#pan").selectAll(".glyph").style("stroke","black").style("stroke-width",2),_.each(Object.keys(a.plots),function(b){a.plots[b].enabled.pan=!0,a.plots[b].enabled.zoom=!1})},a.events.Shift.up=function(){d3.selectAll(".glyphbox#pan").selectAll(".glyph").style("stroke","#ddd").style("stroke-width",1),_.each(Object.keys(a.plots),function(b){a.plots[b].enabled.pan=!1,a.plots[b].enabled.zoom=!0})}},this.enableannotation=function(){a.log("enabling annotation events"),d.attr.svg.on("click",function(){if(d.enabled.annotate){var b=c(d.attr.svg);if(b.x>d.innerwidth+d.attr.margin.left||b.x<d.attr.margin.left||b.y>d.innerheight+d.attr.margin.top||b.y<d.attr.margin.top)return;var e=d3.scale.linear().domain(d.xscale.range()).range(d.xscale.domain()),f=d3.scale.linear().domain(d.yscale.range()).range(d.yscale.domain()),g={x:e(b.x-d.attr.margin.left),y:f(b.y-d.attr.margin.top)};for(var h in d.attr.annotation){var i=d.attr.annotation[h];if(Math.abs(d.xscale(i.x())-d.xscale(g.x))<20&&Math.abs(d.yscale(i.y())-d.yscale(g.y))<20)return}var j={};_.map(Object.keys(d.attr.annotatable),function(a){"add"===a||"function"!=typeof d.attr.annotatable[a]?j[a]=d.attr.annotatable[a]:j[a]=d.attr.annotatable[a](g)});var k=a.annotation(j).bind(d.go).x(g.x).y(g.y);j.x=g.x,j.y=g.y,d.attr.annotation.push(k),d.annotate(),k.events().add(j)}}),a.events.ShiftA.down=function(){d3.selectAll(".glyphbox#annotate").selectAll(".glyph").style("stroke","black").style("stroke-width",2),_.each(Object.keys(a.plots),function(b){a.plots[b].enabled.annotate=!0})},a.events.ShiftA.up=function(){d3.selectAll(".glyphbox#annotate").selectAll(".glyph").style("stroke","#ddd").style("stroke-width",1),_.each(Object.keys(a.plots),function(b){a.plots[b].enabled.annotate=!1})}},this.attr=extend({id:a.uuid(),plotname:"quorra-plot",type:"quorra-plot",width:"auto",height:"auto",margin:{top:20,bottom:40,left:40,right:65},svg:null,bind:"body",data:[],x:function(a,b){return a.x},y:function(a,b){return a.y},group:function(a,b){return"undefined"==typeof a.group?0:a.group},label:function(a,b){return"undefined"==typeof a.label?b:a.label},transform:function(a){return a},color:"auto",xrange:"auto",yrange:"auto",zoomable:!1,annotatable:!1,exportable:!1,selectable:!1,events:{zoom:function(){a.log("zoom event")},pan:function(){a.log("pan event")},panstart:function(){a.log("pan start event")},panend:function(){a.log("pan end event")},preexport:function(){a.log("pre export event")},postexport:function(){a.log("post export event")},click:function(b,c){a.log("clicked plot element")}},grid:!1,xticks:"auto",yticks:"auto",xaxis:"outside",yaxis:"outside",xformat:function(a){return a},yformat:function(a){return a},xorient:"bottom",yorient:"left",xlabel:"",ylabel:"",xorder:[],yorder:[],labelposition:"middle",labelpadding:{x:0,y:0},opacity:1,hovercolor:!1,legend:!0,lmargin:{top:0,bottom:0,left:0,right:0},lposition:"outside",lshape:"square",lorder:[],toggle:!0,toggled:[],selected:[],tooltip:!0,glyphs:!0,gshape:"circle",annotation:[],slider:null},b),parameterize(d.attr,d.go),d.go.__parent__=d,d.go.annotation=function(b){return arguments.length?(d.attr.annotation=_.map(b,function(b){return"function"!=typeof b&&(b=a.annotation(b).bind(d.go)),b}),d.go):_.map(d.attr.annotation,function(a){return a.__parent__.attr})},d.go.annotate=function(a){return"undefined"==typeof d.attr.annotation?d.attr.annotation=[a]:d.attr.annotation.push(a),d.go},this.go}function c(a){var b=d3.mouse(a.node()),c={};return c.x=b[0],c.y=b[1],c.scale="zoom"==d3.event.type?d3.event.scale:1,c}function d(a,b){return function(c){return b.map(function(b){return{x:b,y:d3.mean(c,function(c){return a(b-c)})}})}}function e(a){return function(b){return Math.abs(b/=a)<=1?.75*(1-b*b)/a:0}}function f(b){a.log("instantiating annotation object"),"undefined"==typeof b&&(b={}),"undefined"==typeof plot&&(plot="body");var d=this;return this.go=function(){a.log("running annotation generator function"),d3.selectAll("div.annotation-tooltip#"+d.attr.id+"-tooltip").remove(),1==d.attr.tooltip&&(d.attr.tooltip=d3.select("body").append("div").attr("class","annotation-tooltip").attr("id",+d.attr.id+"-tooltip").style("position","fixed").style("visibility","hidden").style("zindex",999)),d.plot.plotarea.selectAll(".annotation#"+d.attr.id).remove();var b=null===d.attr.group?"annotation "+d.attr.type:"annotation "+d.attr.type+" g_"+d.attr.group,e=d.plot.plotarea.append("g").attr("id",d.attr.id).attr("class",b).style("visibility",function(){return _.contains(d.plot.attr.toggled,d.plot.attr.group(d.attr))?"none":"visible"}).style("opacity",d.attr.style.opacity).on("mouseover",function(){d3.select(this).style("opacity",d.attr.hoveropacity),d.attr.tooltip&&d.attr.tooltip.html(d.attr.hovertext).style("visibility","visible").style("left",d3.event.pageX+5+"px").style("top",d3.event.pageY-20+"px")}).on("mousemove",function(){d.attr.tooltip&&d.attr.tooltip.style("left",d3.event.pageX+5+"px").style("top",d3.event.pageY-20+"px")}).on("mouseout",function(){d3.select(this).style("opacity",d.attr.style.opacity),d.attr.tooltip&&d.attr.tooltip.style("visibility","hidden")}).on("click",function(){d.attr.events.click(d.attr)}),f=d.attr.xfixed?d.plot.xstack[0]:d.plot.xscale,g=d.attr.yfixed?d.plot.ystack[0]:d.plot.yscale,h=f(d.attr.x),i=g(d.attr.y);if(d.attr.draggable&&!d.plot.attr.zoomable){var j=d3.behavior.drag().on("dragstart",function(){d.attr.events.dragstart(d.attr)}).on("dragend",function(){d.attr.events.dragend(d.attr)}).on("drag",function(){var a=c(d.plot.attr.svg),b=Math.abs(f(d.attr.width)-f(0)),e=Math.abs(g(d.attr.height)-g(0));b="rect"===d.attr.type?b/2:0,e="rect"===d.attr.type?e/2:0;var j=a.x-d.plot.attr.margin.left-b,k=a.y-d.plot.attr.margin.top-e,l=_.center(j,[0,d.plot.innerwidth-2*b]),m=_.center(k,[0,d.plot.innerheight-2*e]);d3.select(this).attr("transform","translate("+(l-h)+","+(m-i)+")");var n=d3.scale.linear().domain(f.range()).range(f.domain()),o=d3.scale.linear().domain(g.range()).range(g.domain());d.attr.x=n(l),d.attr.y=o(m),d3.select(this).select("text").text(d.attr.text),d.attr.events.drag(d.attr)});e.call(j)}var k;return"rect"===d.attr.type?k=e.selectAll(".rect").data([d.attr]).enter().append("rect").attr("class","rect").attr("transform","rotate("+d.attr.rotate+" "+h+" "+i+")").attr("width",Math.abs(f(d.attr.width)-f(0))).attr("height",Math.abs(g(d.attr.height)-g(0))).attr("x",h).attr("y",i):"circle"===d.attr.type?k=e.selectAll(".circle").data([d.attr]).enter().append("circle").attr("class","circle").attr("r",d.attr.size/2).attr("cx",h).attr("cy",i):"triangle"===d.attr.type&&(k=e.selectAll(".triangle").data([d.attr]).enter().append("path").attr("class","triangle").attr("transform","rotate("+d.attr.rotate+" "+h+" "+i+")").attr("d",function(a){return["M"+(h-a.size/2)+","+(i-a.size/2),"L"+(h+a.size/2)+","+(i-a.size/2),"L"+h+","+(i+a.size/2),"Z"].join("")})),"bottom"===d.attr.stack&&e.stagedown(),"text"!==d.attr.type&&_.map(_.without(Object.keys(d.attr.style),"opacity"),function(a){k.style(a,d.attr.style[a])}),""!==d.attr.text&&e.selectAll(".text").data([d.attr]).enter().append("text").attr("class","text").attr("x",function(a){var b="function"==typeof a.text?a.text(a):a.text,c=h+a.tmargin.x+2*b.toString().length;return"rect"===a.type?c+2:"circle"===a.type?h+a.tmargin.x:"triangle"===a.type?h+a.tmargin.x+a.size/2-3*b.toString().length:h+a.tmargin.x}).attr("y",function(a){var b=i-a.size/2-5;return"rect"===a.type?i-a.tmargin.y-5:"circle"===a.type?b:"triangle"===a.type?b:i-a.tmargin.y}).style("font-size",d.attr.tsize).style("text-anchor","middle").text(d.attr.text),d},this.attr=extend({parent:null,id:a.uuid(),type:"text",text:"",hovertext:"",hoveropacity:.75,xfixed:!1,yfixed:!1,size:15,group:null,rotate:0,tsize:12,tposition:{x:0,y:20},tmargin:{x:0,y:0},trotation:0,x:0,y:0,width:0,height:0,draggable:!1,tooltip:!0,stack:"top",events:{add:function(){a.log("add event")},drag:function(){a.log("drag event")},dragstart:function(){a.log("drag start event")},dragend:function(){a.log("drag end event")},click:function(){a.log("click event")}},style:{opacity:1},meta:{}},b),parameterize(d.attr,d.go),d.go.__parent__=d,d.go.bind=function(a){return arguments.length?(d.attr.parent=a,d.plot=a.__parent__,d.attr.parent=d.plot.attr.id,d.go):d.plot},d.go}function g(a){var c=this;return"undefined"==typeof a&&(a={}),b.call(this,extend({"class":"quorra-bar",layout:"stacked"},a)),this.type="bar",this.plot=function(){c.plotdata=c.hotdata();var a=[],b=c.pallette.domain();"string"==typeof c.plotdata[0].x&&(c.plotdata=c.plotdata.sort(function(a,b){return a.x>b.x}));for(var d in b){var e=_.filter(c.plotdata,function(a){return a.group==b[d]});e=_.map(e,function(a){return a.layer=d,a}),a.push(_.filter(e,function(a){return a.group==b[d]}))}for(var f=_.map(a[0],function(a){return 0}),g=0;g<a.length;g++)a[g]=_.map(a[g],function(a,b){return a.y0=f[b],f[b]=f[b]+a.y,a});var h=c.plotarea.selectAll(".layer").remove().data(a).enter().append("g").attr("class","layer");h.selectAll("rect").remove().data(function(a){return a}).enter().append("rect").attr("class",function(a,b){return"bar g_"+a.group}).attr("x",function(b,d){if(a[0].length>1){var e="string"==typeof c.attr.x(b,d)?.5:0;if("stacked"===c.attr.layout)return c.xscale(c.xmapper(c.attr.x(b,d))-e);var f=Math.abs(c.xscale(c.xmapper(c.attr.x(a[0][1])))-c.xscale(c.xmapper(c.attr.x(a[0][0]))));return c.xscale(c.xmapper(c.attr.x(b,d))-e)+c.pallette.range().indexOf(c.pallette(b.group))*(f/c.pallette.domain().length)}var g=c.xscale.range();return g[1]-g[0]-2}).attr("y",function(a,b){return"stacked"==c.attr.layout?c.yscale(c.ymapper(a.y0+a.y)):c.yscale(c.ymapper(a.y))}).attr("height",function(a,b){return"stacked"==c.attr.layout?c.yscale(c.ymapper(a.y0))-c.yscale(c.ymapper(a.y0+a.y)):_.max([c.innerheight-c.yscale(c.ymapper(a.y)),0])}).attr("width",function(b){if(a[0].length>1){var d=Math.abs(c.xscale(c.xmapper(c.attr.x(a[0][1])))-c.xscale(c.xmapper(c.attr.x(a[0][0]))));return"stacked"===c.attr.layout?d-2:d/c.pallette.domain().length-2}var e=c.xscale.range();return e[1]-e[0]-2}).attr("fill",function(a,b){return c.pallette(a.group)}).style("opacity",c.attr.opacity).style("visibility",function(a){return _.contains(c.attr.toggled,a.group)?"hidden":"visible"}).on("mouseover",function(a,b){d3.select(this).style("opacity",.25),c.attr.tooltip&&c.attr.tooltip.html(a.label).style("visibility","visible").style("left",d3.event.clientX+5+"px").style("top",d3.event.clientY-20+"px")}).on("mousemove",function(a){c.attr.tooltip&&c.attr.tooltip.style("left",d3.event.clientX+5+"px").style("top",d3.event.clientY-20+"px")}).on("mouseout",function(a){d3.select(this).style("opacity",c.attr.opacity),c.attr.tooltip&&c.attr.tooltip.style("visibility","hidden")}).on("click",function(a,b){c.attr.events.click(a,b),c.attr.tooltip&&c.attr.tooltip.style("visibility","hidden")})},this.go}function h(a){var b=this;return"undefined"==typeof a&&(a={}),j.call(this,extend({"class":"quorra-density",resolution:10},a)),this.type="density",b.attr.transform=function(a){var c=d3.format(".04f"),f=d(e(9),d3.scale.linear().ticks(b.attr.resolution)),g=_.uniquesort(a,b.attr.group),h=[];for(var i in g){var j=_.filter(a,function(a){return a.group==g[i]}),k=f(_.map(j,function(a){return a.x}));k=_.map(k,function(a){return{x:a.x,y:a.y,group:g[i],label:c(a.y)}}),h=h.concat(k)}return h},this.go}function i(a){var b=this;return"undefined"==typeof a&&(a={}),g.call(this,extend({"class":"quorra-histogram",bins:10,display:"counts"},a)),this.type="histogram",b.attr.transform=function(a){if("percent"==b.attr.display)var c=d3.format("0.02%");else if("counts"==b.attr.display)var c=d3.format(".0f");else if("fraction"==b.attr.display)var c=d3.format(".02f");var d=d3.layout.histogram().frequency(!1).bins(d3.scale.linear().ticks(b.attr.bins)),e=_.uniquesort(a,b.attr.group),f=[];for(var g in e){var h=_.filter(a,function(a){return a.group==e[g]}),i=d(_.map(h,function(a){return a.x}));i=_.map(i,function(a){return"counts"==b.attr.display?a.y=a.y*h.length:"percent"==b.attr.display&&(a.y=a.y),{x:a.x,y:a.y,group:e[g],label:c(a.y)}}),f=f.concat(i)}return f},this.go}function j(c){var d=this;return"undefined"==typeof c&&(c={}),b.call(this,extend({"class":"quorra-line",points:0,size:3,layout:"line",interpolate:"linear"},c)),this.type="line",this.plot=function(){a.log("drawing plot data");var b=d3.svg.line().x(function(a,b){return d.xscale(d.xmapper(d.attr.x(a,b)))}).y(function(a,b){return d.yscale(d.ymapper(d.attr.y(a,b)))}).interpolate(d.attr.interpolate);d.plotdata=d.hotdata();var c=d.pallette.domain();for(var e in c){var f=_.filter(d.plotdata,function(a){return a.group==c[e]});0!=f.length&&d.plotarea.append("path").datum(f).attr("class",function(a,b){return"line g_"+a[0].group}).attr("d",function(a){var c=b(a);return"line"===d.attr.layout?c:"area"===d.attr.layout?[c,"L"+d.xscale(d.xmapper(d.domain[d.domain.length-1]))+","+d.yscale(d.ymapper(d.range[0])),"L"+d.xscale(d.xmapper(d.domain[0]))+","+d.yscale(d.ymapper(d.range[0])),"Z"].join(""):void 0}).style("fill",function(a){return"line"===d.attr.layout?"none":"area"===d.attr.layout?d.pallette(a[0].group):void 0}).style("stroke",function(a,b){return _.contains(d.attr.selected,d.attr.group(a[0],b))?d.attr.hovercolor!==!1?d.attr.hovercolor:"firebrick":d.pallette(d.attr.group(a[0],b))}).style("stroke-width",d.attr.size).style("opacity",d.attr.opacity).style("visibility",function(a,b){return _.contains(d.attr.toggled,d.attr.group(a[0],b))?"hidden":"visible"}).on("mouseover",function(a,b){_.contains(d.attr.selected,d.attr.group(a[0],b))||(d.attr.hovercolor!==!1?(d.plotarea.selectAll(".dot.g_"+a[0].group).style("fill",d.attr.hovercolor),d.plotarea.selectAll(".line.g_"+a[0].group).style("stroke",d.attr.hovercolor),null!==d.attr.slider&&(d.attr.slider.__parent__.plotarea.selectAll(".dot.g_"+a[0].group).style("fill",d.attr.hovercolor),d.attr.slider.__parent__.plotarea.selectAll(".line.g_"+a[0].group).style("stroke",d.attr.hovercolor))):(d.plotarea.selectAll(".g_"+a[0].group).style("opacity",.25),null!==d.attr.slider&&d.attr.slider.__parent__.selectAll(".g_"+a[0].group).style("opacity",.25)),d.attr.tooltip&&d.attr.tooltip.html(a[0].group).style("visibility","visible").style("left",d3.event.clientX+5+"px").style("top",d3.event.clientY-20+"px"))}).on("mousemove",function(a){d.attr.tooltip&&d.attr.tooltip.style("left",d3.event.clientX+5+"px").style("top",d3.event.clientY-20+"px")}).on("mouseout",function(a){d.attr.hovercolor!==!1?(d.plotarea.selectAll(".dot.g_"+a[0].group).style("fill",d.pallette(a[0].group)),d.plotarea.selectAll(".line.g_"+a[0].group).style("stroke",d.pallette(a[0].group)),null!==d.attr.slider&&(d.attr.slider.__parent__.plotarea.selectAll(".dot.g_"+a[0].group).style("fill",d.pallette(a[0].group)),
d.attr.slider.__parent__.plotarea.selectAll(".line.g_"+a[0].group).style("stroke",d.pallette(a[0].group)))):(d.plotarea.selectAll(".g_"+a[0].group).style("opacity",d.attr.opacity),null!==d.attr.slider&&d.attr.slider.__parent__.selectAll(".g_"+a[0].group).style("opacity",d.attr.opacity)),d.attr.tooltip&&d.attr.tooltip.style("visibility","hidden")}).on("click",function(a,b){d.attr.selectable!==!1&&(d.attr.selected=selectmerge(d.attr.selected,a[0].group,d.attr.selectable),d.redraw(d.xscale.domain(),d.yscale.domain(),!1)),d.attr.slider&&(d.attr.slider.__parent__.attr.selected=d.attr.selected,d.attr.slider.__parent__.redraw()),d.attr.tooltip&&d.attr.tooltip.style("visibility","hidden"),d.attr.events.click(a,b)})}d.attr.points>0&&d.plotarea.selectAll(".dot").remove().data(d.plotdata).enter().append("circle").attr("class",function(a,b){return"dot g_"+a.group}).attr("r",d.attr.points).attr("cx",function(a,b){return d.xscale(d.xmapper(d.attr.x(a,b)))}).attr("cy",function(a,b){return d.yscale(d.ymapper(d.attr.y(a,b)))}).style("fill",function(a,b){return _.contains(d.attr.selected,d.attr.group(a,b))?d.attr.hovercolor!==!1?d.attr.hovercolor:"firebrick":d.pallette(d.attr.group(a,b))}).style("opacity",d.attr.opacity).style("visibility",function(a,b){return _.contains(d.attr.toggled,d.attr.group(a,b))?"hidden":"visible"}).on("mouseover",function(a,b){d3.select(this).style("opacity",.25),d.attr.tooltip&&d.attr.tooltip.html(d.attr.label(a,b)).style("visibility","visible").style("left",d3.event.clientX+5+"px").style("top",d3.event.clientY-20+"px")}).on("mousemove",function(a){d.attr.tooltip&&d.attr.tooltip.style("left",d3.event.clientX+5+"px").style("top",d3.event.clientY-20+"px")}).on("mouseout",function(a){d3.select(this).style("opacity",d.attr.opacity),d.attr.tooltip&&d.attr.tooltip.style("visibility","hidden")}).on("click",function(a,b){d.attr.selectable!==!1&&(d.attr.selected=selectmerge(d.attr.selected,a.group,d.attr.selectable),d.redraw(d.xscale.domain(),d.yscale.domain(),!1)),d.attr.slider&&(d.attr.slider.__parent__.attr.selected=d.attr.selected,d.attr.slider.__parent__.redraw()),d.attr.tooltip&&d.attr.tooltip.style("visibility","hidden"),d.attr.events.click(a,b)})},this.go}function k(c){var d=this;return"undefined"==typeof c&&(c={}),b.call(this,extend({"class":"quorra-multiline",points:0,size:3,layout:"line",interpolate:"linear",margin:{top:30,bottom:20,left:0,right:70},yranges:{}},c)),this.type="multiline",this.axes=function(){a.log("redrawing axes");var b="auto"===d.attr.xrange?d.domain:d.attr.xrange;"auto"===d.attr.yrange?d.range:d.attr.yrange;d.xord=d3.scale.ordinal().domain(d.domain).range(_.range(d.domain.length)),d.xordrev=d3.scale.ordinal().domain(d.xord.range()).range(d.xord.domain()),d.xmapper=function(a){return d.xord(a)},"string"==typeof b[0]&&(b=_.map(b,d.xmapper),b[0]=b[0]-.5,b[b.length-1]=b[b.length-1]+.5),d.xscale=d3.scale.linear().domain([b[0],b[b.length-1]]).range([0,d.innerwidth]),d.xaxis=d3.svg.axis().scale(d.xscale).orient("top"),"auto"!==d.attr.xticks&&(d.xaxis=d.xaxis.ticks(d.attr.xticks)),d.xaxis=d.xaxis.tickFormat(d.attr.xformat),"string"==typeof b[0]&&(b=_.map(b,d.xord)),d.xaxis=d.xaxis.tickValues(_.range(Math.ceil(b[0]),Math.floor(b[b.length-1])+1)).tickFormat(function(a){return d.attr.xformat(d.xordrev(a))}).tickSize(0).tickPadding(15),d.plotregion.append("g").attr("class","x axis").call(d.xaxis),d.plotregion.selectAll(".x.axis .domain").remove(),d.yscale=d3.scale.linear().domain([0,1]).range([d.innerheight,0]),d.yscales=[],d.yaxes=[];for(var c=(d.xscale(1)-d.xscale(0),0);c<d.domain.length;c++){var e=_.filter(d.data,function(a){return a.x===d.domain[c]});if(e=_.map(e,function(a){return a.y}),void 0!==d.attr.yranges[d.domain[c]])var b=d.attr.yranges[d.domain[c]];else var b=[_.min(e),_.max(e)];var f=d3.scale.linear().domain(b).range([0,1]);d.yscales.push(f);var g=d3.scale.linear().domain(b).range(d.yscale.range()).nice(),h=d3.svg.axis().scale(g).orient("left");"auto"!==d.attr.yticks&&(h=h.ticks(d.attr.yticks)),h=h.tickFormat(d.attr.yformat),d.yaxes.push(h),d.plotregion.append("g").attr("transform","translate("+d.xscale(c)+",0)").attr("class","y axis").call(h)}},this.plot=function(){a.log("drawing plot data"),d.plotdata=d.data;var b=d.pallette.domain();for(var c in b){var e=d3.svg.line().x(function(a,b){return d.xscale(d.xmapper(d.attr.x(a,b)))}).y(function(a,b){return d.yscale(d.yscales[d.xord(a.x)](a.y))}).interpolate(d.attr.interpolate),f=_.filter(d.plotdata,function(a){return a.group===b[c]});0!=f.length&&(f=f.sort(function(a,b){return d.domain.indexOf(a.x)-d.domain.indexOf(b.x)}),d.plotarea.append("path").datum(f).attr("class",function(a,b){return"line g_"+a[0].group}).attr("d",function(a){var b=e(a);return"line"===d.attr.layout?b:"area"===d.attr.layout?[b,"L"+d.xscale(d.xmapper(d.domain[d.domain.length-1]))+","+d.yscale(0),"L"+d.xscale(d.xmapper(d.domain[0]))+","+d.yscale(1),"Z"].join(""):void 0}).style("fill",function(a){return"line"===d.attr.layout?"none":"area"===d.attr.layout?d.pallette(a[0].group):void 0}).style("stroke",function(a,b){return _.contains(d.attr.selected,d.attr.group(a[0],b))?d.attr.hovercolor!==!1?d.attr.hovercolor:"firebrick":d.pallette(d.attr.group(a[0],b))}).style("stroke-width",d.attr.size).style("opacity",d.attr.opacity).style("visibility",function(a,b){return _.contains(d.attr.toggled,d.attr.group(a[0],b))?"hidden":"visible"}).on("mouseover",function(a,b){_.contains(d.attr.selected,d.attr.group(a[0],b))||(d.attr.hovercolor!==!1?(d.plotarea.selectAll(".dot.g_"+a[0].group).style("fill",d.attr.hovercolor),d.plotarea.selectAll(".line.g_"+a[0].group).style("stroke",d.attr.hovercolor)):d.plotarea.selectAll(".g_"+a[0].group).style("opacity",.25),d.attr.tooltip&&d.attr.tooltip.html(a[0].group).style("visibility","visible").style("left",d3.event.clientX+5+"px").style("top",d3.event.clientY-20+"px"))}).on("mousemove",function(a){d.attr.tooltip&&d.attr.tooltip.style("left",d3.event.clientX+5+"px").style("top",d3.event.clientY-20+"px")}).on("mouseout",function(a,b){_.contains(d.attr.selected,d.attr.group(a[0],b))||(d.attr.hovercolor!==!1?(d.plotarea.selectAll(".dot.g_"+a[0].group).style("fill",d.pallette(a[0].group)),d.plotarea.selectAll(".line.g_"+a[0].group).style("stroke",d.pallette(a[0].group))):d.plotarea.selectAll(".g_"+a[0].group).style("opacity",d.attr.opacity),d.attr.tooltip&&d.attr.tooltip.style("visibility","hidden"))}).on("click",function(a,b){d.attr.selectable!==!1&&(d.attr.selected=selectmerge(d.attr.selected,a[0].group,d.attr.selectable),d.redraw(d.xscale.domain(),d.yscale.domain(),!1)),d.attr.slider&&(d.attr.slider.__parent__.attr.selected=d.attr.selected,d.attr.slider.__parent__.redraw()),d.attr.tooltip&&d.attr.tooltip.style("visibility","hidden"),d.attr.events.click(a,b)}))}d.attr.points>0&&d.plotarea.selectAll(".dot").remove().data(d.plotdata).enter().append("circle").attr("class",function(a,b){return"dot g_"+a.group}).attr("r",d.attr.points).attr("cx",function(a,b){return d.xscale(d.xmapper(d.attr.x(a,b)))}).attr("cy",function(a,b){return d.yscale(d.yscales[d.xord(a.x)](a.y))}).style("fill",function(a,b){return _.contains(d.attr.selected,d.attr.group(a,b))?d.attr.hovercolor!==!1?d.attr.hovercolor:"firebrick":d.pallette(d.attr.group(a,b))}).style("opacity",d.attr.opacity).style("visibility",function(a,b){return _.contains(d.attr.toggled,d.attr.group(a,b))?"hidden":"visible"}).on("mouseover",function(a,b){_.contains(d.attr.selected,d.attr.group(a,b))||(d.attr.hovercolor!==!1?(d.plotarea.selectAll(".dot.g_"+a.group).style("fill",d.attr.hovercolor),d.plotarea.selectAll(".line.g_"+a.group).style("stroke",d.attr.hovercolor)):d.plotarea.selectAll(".g_"+a.group).style("opacity",.25),d.attr.tooltip&&d.attr.tooltip.html(d.attr.label(a,b)).style("visibility","visible").style("left",d3.event.clientX+5+"px").style("top",d3.event.clientY-20+"px"))}).on("mousemove",function(a){d.attr.tooltip&&d.attr.tooltip.style("left",d3.event.clientX+5+"px").style("top",d3.event.clientY-20+"px")}).on("mouseout",function(a,b){_.contains(d.attr.selected,d.attr.group(a,b))||(d.attr.hovercolor!==!1?(d.plotarea.selectAll(".dot.g_"+a.group).style("fill",d.pallette(d.attr.group(a,b))),d.plotarea.selectAll(".line.g_"+a.group).style("stroke",d.pallette(d.attr.group(a,b)))):d.plotarea.selectAll(".g_"+a.group).style("opacity",d.attr.opacity),d.attr.tooltip&&d.attr.tooltip.style("visibility","hidden"))}).on("click",function(a,b){d.attr.selectable!==!1&&(d.attr.selected=selectmerge(d.attr.selected,a.group,d.attr.selectable),d.redraw(d.xscale.domain(),d.yscale.domain(),!1)),d.attr.slider&&(d.attr.slider.__parent__.attr.selected=d.attr.selected,d.attr.slider.__parent__.redraw()),d.attr.tooltip&&d.attr.tooltip.style("visibility","hidden"),d.attr.events.click(a,b)})},this.go}function l(a){var c=this;return"undefined"==typeof a&&(a={}),b.call(this,extend({"class":"quorra-pie",aggregate:function(a){return a[0]},radius:"auto",inner:"auto"},a)),this.type="pie",this.axes=function(){},this.plot=function(){var a="auto"==c.attr.width?parseInt(c.selection.style("width")):c.attr.width,b="auto"==c.attr.height?parseInt(c.selection.style("height")):c.attr.height;a=a-c.attr.margin.left-c.attr.margin.right,b=b-c.attr.margin.top-c.attr.margin.bottom;var d="auto"==c.attr.radius?Math.min(a,b)/2:c.attr.radius,e="auto"==c.attr.inner?0:c.attr.inner,f=[],g=c.pallette.domain();for(var h in g){var i=_.filter(c.data,function(a){return a.group==g[h]});f.push({x:c.attr.aggregate(_.map(i,function(a){return a.x})),group:g[h],label:i.length<=1?g[h]:i.length+" "+g[h]})}var j=d3.svg.arc().outerRadius(d).innerRadius(e),k=d3.layout.pie().sort(null).value(function(a){return a.x}),l=c.plotregion.attr("transform","translate("+c.innerwidth/2+","+c.innerheight/2+")").selectAll(".arc").data(k(f)).enter().append("g").attr("class",function(a){return"arc g_"+a.data.group}).style("visibility",function(a){return _.contains(c.attr.toggled,c.attr.group(a.data))?"hidden":"visible"});l.append("path").attr("d",j).style("fill",function(a,b){return c.pallette(c.attr.group(a.data,b))}).style("opacity",c.attr.opacity).on("mouseover",function(a,b){d3.select(this).style("opacity",.25),c.attr.tooltip&&c.attr.tooltip.html(c.attr.label(a.data,b)).style("visibility","visible").style("left",d3.event.clientX+5+"px").style("top",d3.event.clientY-20+"px")}).on("mousemove",function(a){c.attr.tooltip&&c.attr.tooltip.style("left",d3.event.clientX+5+"px").style("top",d3.event.clientY-20+"px")}).on("mouseout",function(a){d3.select(this).style("opacity",c.attr.opacity),c.attr.tooltip&&c.attr.tooltip.style("visibility","hidden")}).on("click",c.attr.events.click)},this.go}function m(c){var d=this;return"undefined"==typeof c&&(c={}),b.call(this,extend({"class":"quorra-scatter",lm:!1,xdensity:!1,ydensity:!1,xjitter:0,yjitter:0,size:5,line:!1,lineinterpolate:"linear",linelayout:"line",linesize:3},c)),this.type="scatter",this.plot=function(){d.xscale.domain();if(d.plotdata=_.map(d.hotdata(),function(b,c){var e=extend({},b);return e.x=(a.pseudorandom(c)-.5)*d.attr.xjitter+d.xscale(d.xmapper(d.attr.x(b,c))),e.y=(a.pseudorandom(c)-.5)*d.attr.yjitter+d.yscale(d.ymapper(d.attr.y(b,c))),e}),d.attr.line!==!1){var b=d3.svg.line().x(function(a,b){return a.x}).y(function(a,b){return a.y}).interpolate(d.attr.lineinterpolate),c=d.pallette.domain();for(var e in c){var f=_.filter(d.plotdata,function(a){return a.group==c[e]});0!=f.length&&d.plotarea.append("path").datum(f).attr("class",function(a,b){return"line g_"+a[0].group}).attr("d",function(a){var c=b(a);return"line"===d.attr.linelayout?c:"area"===d.attr.linelayout?[c,"L"+d.xscale(d.xmapper(d.domain[d.domain.length-1]))+","+d.yscale(d.ymapper(d.range[0])),"L"+d.xscale(d.xmapper(d.domain[0]))+","+d.yscale(d.ymapper(d.range[0])),"Z"].join(""):void 0}).style("fill",function(a){return"line"===d.attr.linelayout?"none":"area"===d.attr.linelayout?d.pallette(a[0].group):void 0}).style("stroke",function(a,b){return _.contains(d.attr.selected,d.attr.group(a[0],b))?d.attr.hovercolor!==!1?d.attr.hovercolor:"firebrick":d.pallette(d.attr.group(a[0],b))}).style("stroke-width",d.attr.linesize).style("opacity",d.attr.opacity).style("visibility",function(a,b){return _.contains(d.attr.selected,d.attr.group(a[0],b))?"visible":"hover"===d.attr.line?"hidden":d.attr.line?_.contains(d.attr.toggled,d.attr.group(a[0],b))?"hidden":"visible":void 0}).on("click",function(a,b){d.attr.selectable!==!1&&(d.attr.selected=selectmerge(d.attr.selected,a[0].group,d.attr.selectable),d.redraw(d.xscale.domain(),d.yscale.domain(),!1)),d.attr.slider&&(d.attr.slider.__parent__.attr.selected=d.attr.selected,d.attr.slider.__parent__.redraw()),d.attr.tooltip&&d.attr.tooltip.style("visibility","hidden"),d.attr.events.click(a,b)})}}d.plotarea.selectAll(".dot").remove().data(d.plotdata).enter().append("circle").attr("class",function(a,b){return"dot g_"+a.group}).attr("r",d.attr.size).attr("cx",function(a,b){return a.x}).attr("cy",function(a,b){return a.y}).style("fill",function(a,b){return _.contains(d.attr.selected,d.attr.group(a,b))?d.attr.hovercolor!==!1?d.attr.hovercolor:"firebrick":d.pallette(d.attr.group(a,b))}).style("opacity",d.attr.opacity).style("visibility",function(a){return _.contains(d.attr.toggled,d.attr.group(a))?"hidden":"visible"}).attr("clip-path","url(#clip)").on("mouseover",function(a,b){_.contains(d.attr.selected,d.attr.group(a,b))||("hover"===d.attr.line&&d.plotarea.selectAll(".line.g_"+a.group).style("visibility","visible"),d.attr.hovercolor!==!1?(d.plotarea.selectAll(".dot.g_"+a.group).style("fill",d.attr.hovercolor),d.plotarea.selectAll(".line.g_"+a.group).style("stroke",d.attr.hovercolor),null!==d.attr.slider&&(d.attr.slider.__parent__.plotarea.selectAll(".dot.g_"+a.group).style("fill",d.attr.hovercolor),d.attr.slider.__parent__.plotarea.selectAll(".line.g_"+a.group).style("stroke",d.attr.hovercolor))):(d3.select(this).style("opacity",.25),null!==d.attr.slider&&d.attr.slider.__parent__.plotarea.selectAll(".g_"+a.group).style("opacity",.25)),d.attr.tooltip&&d.attr.tooltip.html(d.attr.label(a,b)).style("visibility","visible").style("left",d3.event.clientX+5+"px").style("top",d3.event.clientY-20+"px"))}).on("mousemove",function(a){d.attr.tooltip&&d.attr.tooltip.style("left",d3.event.clientX+5+"px").style("top",d3.event.clientY-20+"px")}).on("mouseout",function(a,b){_.contains(d.attr.selected,d.attr.group(a,b))||("hover"===d.attr.line&&d.plotarea.selectAll(".line.g_"+a.group).style("visibility","hidden"),d.attr.hovercolor!==!1?(d.plotarea.selectAll(".dot.g_"+a.group).style("fill",d.pallette(d.attr.group(a,b))),d.plotarea.selectAll(".line.g_"+a.group).style("stroke",d.pallette(d.attr.group(a,b))),null!==d.attr.slider&&(d.attr.slider.__parent__.plotarea.selectAll(".dot.g_"+a.group).style("fill",d.pallette(d.attr.group(a,b))),d.attr.slider.__parent__.plotarea.selectAll(".line.g_"+a.group).style("stroke",d.pallette(d.attr.group(a,b))))):(d3.select(this).style("opacity",d.attr.opacity),null!==d.attr.slider&&d.attr.slider.__parent__.plotarea.selectAll(".g_"+a.group).style("opacity",d.attr.opacity)),d3.select(this).style("opacity",d.attr.opacity),d.attr.tooltip&&d.attr.tooltip.style("visibility","hidden"))}).on("click",function(a,b){d.attr.selectable!==!1&&(d.attr.selected=selectmerge(d.attr.selected,a.group,d.attr.selectable),d.redraw(d.xscale.domain(),d.yscale.domain(),!1)),d.attr.slider&&(d.attr.slider.__parent__.attr.selected=d.attr.selected,d.attr.slider.__parent__.redraw()),d.attr.tooltip&&d.attr.tooltip.style("visibility","hidden"),d.attr.events.click(a,b)}),d.attr.xdensity&&d.plotarea.selectAll(".xtick").remove().data(d.plotdata).enter().append("line").attr("clip-path","url(#clip)").attr("class",function(a,b){return"xtick g_"+a.group}).attr("x1",function(a,b){return d.xscale(d.xmapper(d.attr.x(a,b)))}).attr("x2",function(a,b){return d.xscale(d.xmapper(d.attr.x(a,b)))}).attr("y1",function(a,b){return d.innerheight}).attr("y2",function(a,b){return d.innerheight-10}).attr("stroke",function(a,b){return d.pallette(d.attr.group(a,b))}).style("opacity",d.attr.opacity).style("visibility",function(a,b){return _.contains(d.attr.toggled,d.attr.group(a,b))?"hidden":"visible"}),d.attr.ydensity&&d.plotarea.selectAll(".ytick").remove().data(d.plotdata).enter().append("line").attr("clip-path","url(#clip)").attr("class",function(a,b){return"ytick g_"+a.group}).attr("x1",function(a,b){return 0}).attr("x2",function(a,b){return 10}).attr("y1",function(a,b){return d.yscale(d.ymapper(d.attr.y(a,b)))}).attr("y2",function(a,b){return d.yscale(d.ymapper(d.attr.y(a,b)))}).attr("stroke",function(a,b){return d.pallette(d.attr.group(a,b))}).style("opacity",d.attr.opacity).style("visibility",function(a,b){return _.contains(d.attr.toggled,d.attr.group(a,b))?"hidden":"visible"}),0!=d.attr.lm&&a.error("Not yet implemented!")},this.go}a.debug=!1,a.error=function(a){console.log("ERROR: "+a)},a.log=function(b){a.debug&&console.log("DEBUG: "+b)},a.render=function(b){a.log("rendering element");var c=b();return"undefined"==typeof b.parent&&(a.plots[b.id()]=c),c},a.plots={};var n={16:"Shift",17:"Ctrl",18:"Alt",27:"Esc"},o={9:"Tab",13:"Enter",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z"},p=_.extend(_.clone(n),o);a.keys={},_.each(p,function(b){a.keys[b]=!1}),a.events={},_.each(n,function(b){a.events[b]={down:function(){},up:function(){}},_.each(o,function(c){a.events[b+c]={down:function(){},up:function(){}}})}),document.onkeydown=function(b){b=b||window.event;var c=b.which;_.has(p,c)&&(a.keys[p[c]]=!0,_.has(o,c)?_.each(n,function(b){a.keys[b]&&a.events[b+o[c]].down()}):a.events[p[c]].down())},document.onkeyup=function(b){b=b||window.event;var c=b.which;_.has(p,c)&&(a.keys[p[c]]=!1,_.has(o,c)?_.each(n,function(b){a.keys[b]&&a.events[b+o[c]].up()}):a.events[p[c]].up())};var q=Math.round(1e5*Math.random());a.seed=function(a){return arguments.length?void(q=a):q},a.random=function(){"undefined"==typeof q&&(q=42);var a=1e4*Math.sin(q++);return a-Math.floor(a)},a.pseudorandom=function(a){var b=1e4*Math.sin(a);return b-Math.floor(b)},a.uuid=function(){function b(){return Math.floor(65536*(1+a.random())).toString(16).substring(1)}return"u"+[b()+b(),b(),b(),b(),b()+b()+b()].join("-")},a["export"]=function(a,b){var c=a.attr({xmlns:"http://www.w3.org/2000/svg",version:"1.1"}).node(),d=c.cloneNode(!0);d3.select(d).selectAll("clippath").attr("id","clip-export"),d3.select(d).selectAll(".plotarea").attr("clip-path","url(#clip-export)"),d.id="export",document.body.appendChild(d),d3.select(d).style("background-color","#fff"),d3.select(d).selectAll(".glyphbox").remove(),d3.select(d).selectAll("text").style("font-weight",300).style("font-size","12px").style("font-family",'"HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif'),d3.select(d).selectAll(".axis line").style("stroke","#bbb").style("fill","none").style("shape-rendering","crispEdges"),d3.select(d).selectAll(".axis path").style("stroke","#bbb").style("fill","none").style("shape-rendering","crispEdges"),d3.select(d).selectAll(".axis .tick line").style("stroke","#bbb").style("opacity",.5),d3.select(d).selectAll(".selector").style("stroke","#bbb").style("stroke-width","1px"),d3.select(d).selectAll(".xtick").style("stroke-width","1.5px"),d3.select(d).selectAll(".ytick").style("stroke-width","1.5px");var e=document.createElement("canvas"),f=e.getContext("2d"),g=d.getBoundingClientRect(),h=(new XMLSerializer).serializeToString(d);e.width=g.width,e.height=g.height;var i=document.createElement("img");i.setAttribute("src","data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(h)))),i.onload=function(){f.drawImage(i,0,0);var a=e.toDataURL("image/png"),c=document.createElement("a");c.download=b+".png",c.href=a,document.body.appendChild(c),c.click(),c.remove(),e.remove(),document.body.removeChild(d)}},_.center=function(a,b){return _.min([_.max([a,b[0]]),b[1]])},_.uniquesort=function(a,b){return"undefined"==typeof b&&(b=function(a){return a}),_.unique(_.map(a,b)).sort()},d3.selection.prototype.stageup=function(){return this.each(function(){this.parentNode.appendChild(this)})},d3.selection.prototype.stagedown=function(){return this.each(function(){var a=this.parentNode.firstChild;a&&this.parentNode.insertBefore(this,a)})},parameterize=function(a,b){Object.keys(a).forEach(function(c){b[c]=function(d){return arguments.length?("object"==typeof d&&"object"==typeof a[c]?(Array.isArray(a[c])&&!Array.isArray(d)&&(d=[d]),a[c]=_.extend(a[c],d)):a[c]=d,b):a[c]}})},extend=function(a,b){return _.map(Object.keys(b),function(c){"undefined"==typeof a[c]&&(a[c]=b[c])}),_.map(Object.keys(a),function(c){"undefined"!=typeof b[c]&&("object"!=typeof a[c]||Array.isArray(a[c])||null==a[c]?Array.isArray(a[c])&&!Array.isArray(b[c])?a[c]=[b[c]]:a[c]=b[c]:a[c]=extend(a[c],b[c]))}),a},selectmerge=function(a,b,c){"undefined"==typeof c&&(c=!0);var d=a;return"single"==c&&(a=[]),_.contains(d,b)?a=_.without(a,b):a.push(b),a},a.annotation=function(b){return a.log("creating plot annotation"),new f(b)},g.prototype=Object.create(b.prototype),g.prototype.constructor=g,a.bar=function(a){return new g(a)},h.prototype=Object.create(j.prototype),h.prototype.constructor=h,a.density=function(a){return new h(a)},i.prototype=Object.create(g.prototype),i.prototype.constructor=i,a.histogram=function(a){return new i(a)},j.prototype=Object.create(b.prototype),j.prototype.constructor=j,a.line=function(a){return new j(a)},k.prototype=Object.create(b.prototype),k.prototype.constructor=k,a.multiline=function(a){return new k(a)},l.prototype=Object.create(b.prototype),l.prototype.constructor=l,a.pie=function(a){return new l(a)},m.prototype=Object.create(b.prototype),m.prototype.constructor=m,a.scatter=function(a){return new m(a)},a.version="0.0.2",window.quorra=a}();